<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Tracking</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        #controls, #info {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            font-family: Arial, Helvetica, sans-serif;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        #controls {
            top: 10px;
        }

        #info {
            top: 70px;
        }
    </style>
</head>
<body>

    <div id="controls">
        <label><strong>Speed:</strong></label>
        <input type="range" id="speedSlider" min="200" max="3000" value="1000" step="100">
        <span id="speedValue">1000 ms</span>
    </div>

    <div id="info">
        <div>📏 Distance: <span id="distance">0</span></div>
        <div>⏱ ETA: <span id="eta">0</span></div>
    </div>

    <div id="map"></div>

    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>

        // ===============================
        // MAP INITIALIZATION
        // ===============================
        const map = L.map('map').setView([30.1061, 31.3273], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // ===============================
        // ROUTE (must match backend)
        // ===============================
        const route = [
            [30.135563454296484, 31.349931555835006],
            [30.135490384301878, 31.35009785278544],
            [30.13566320055098, 31.350215869976072],
            [30.135855733733923, 31.349731731273593],
            [30.13678939838092, 31.35036070928183],
            [30.134378004057137, 31.355767301656957],
            [30.131956747794263, 31.354331476993305],
            [30.130768900128874, 31.356787788008567],
            [30.129248762174345, 31.35759969424369],
            [30.128880929996892, 31.3575949863931],
            [30.128405992746597, 31.356395143050328],
            [30.128084266259464, 31.35512442331699],
            [30.127999591432804, 31.354958126366558],
            [30.127967113397826, 31.35482401592266],
            [30.12769198750652, 31.354204949052452],
            [30.1276943073742, 31.354214336791948],
            [30.12696892231725, 31.35182046780242],
            [30.127018799799405, 31.351748048162715],
            [30.12702459950499, 31.351616619927697],
            [30.12697936179234, 31.35152944813916],
            [30.126844808473233, 31.35149592052818],
            [30.12674041352599, 31.351337670194525],
            [30.12636310983247, 31.35114090076227],
            [30.126008069159408, 31.350202327563583],
            [30.123944050523548, 31.346491159444685],
            [30.123831532663896, 31.346155883334937],
            [30.122560186994303, 31.344148975658474],
            [30.120026779716223, 31.34083619774311],
            [30.119990818987738, 31.34080267013214],
            [30.114886038665, 31.334438587419648],
            [30.11479903235182, 31.334431881897455],
            [30.11472362681838, 31.334470773926185],
            [30.114716666304687, 31.33459951995232],
            [30.11475958946357, 31.334736312602434],
            [30.117985780591656, 31.33874917696285],
            [30.11895093520293, 31.339875704706266],
            [30.11881637094637, 31.34028340050117],
            [30.1185426017158, 31.340436286407215],
            [30.11844747833092, 31.340436286407215],
            [30.117510204708676, 31.34119444631213],
            [30.11698146281315, 31.34148805628716],
            [30.11378321794553, 31.343857938167243],
            [30.111595251465957, 31.3456469715517],
            [30.111418912717433, 31.34561746725404],
            [30.11118224705399, 31.34568452248366],
            [30.111031430408097, 31.345660382603757],
            [30.109311601353536, 31.345124656525492],
            [30.108928751400313, 31.344840342384423],
            [30.105757750540807, 31.343807366467573],
            [30.105648692540466, 31.343624976263875],
            [30.106137212397467, 31.342697980351257],
            [30.10668481885981, 31.341410520089816],
            [30.106643052372128, 31.34123617651275],
            [30.10653631571227, 31.341185214544065],
            [30.10641797710682, 31.34118253233519],
            [30.105436457319033, 31.343454363325215],
            [30.105332039732026, 31.343489232064993],
            [30.105127845051296, 31.343679668895334],
            [30.103031093211, 31.343317662966243],
            [30.101585027385713, 31.34312824205474],
            [30.100823907104864, 31.34306923346148],
            [30.100768215143045, 31.342723228488154],
            [30.10065451063358, 31.342599846879768],
            [30.100468870336986, 31.342484511898014],
            [30.10028555020196, 31.342441596555968],
            [30.09996067824141, 31.342570342582114],
            [30.099786639235948, 31.342919029746373],
            [30.094509154510714, 31.34211567758564],
            [30.094388480846415, 31.342088855482764],
            [30.092061935077346, 31.34174846405557],
            [30.090892293711097, 31.34150438303425],
            [30.09057899456065, 31.341442692215413],
            [30.08672054421463, 31.340842296517913],
            [30.08627494410996, 31.340858389769547],
            [30.080437838891765, 31.34001248014423],
            [30.07939339415808, 31.339797903425506],
            [30.079203071931186, 31.339693297279265],
            [30.077210239683495, 31.339383191942268],
            [30.070101430323177, 31.338321707688337],
            [30.06942827543422, 31.338209060651614],
            [30.06915901188807, 31.338112501132006],
            [30.068991882421965, 31.337946204181574],
            [30.068843322659582, 31.337399033570463],
            [30.068750472684854, 31.336540726694462],
            [30.06858798503694, 31.336390522997295],
            [30.06825372389381, 31.336267141388905],
            [30.068207298633016, 31.336240319297115],
            [30.065396245866648, 31.336602160643835],
            [30.065066616617134, 31.33672017783447],
            [30.062289993234693, 31.33708439615543],
            [30.061486784964114, 31.337213142187327],
            [30.06097607110624, 31.33726142194466],
            [30.05640375688445, 31.337897771756804],
            [30.054825097248088, 31.338214272407146],
            [30.054699732022947, 31.338246458920807],
            [30.053608583532377, 31.338375204967488],
            [30.05181116795883, 31.338586220200003],
            [30.044851165155862, 31.339624544301476],
            [30.04461898381994, 31.33743586168235],
            [30.04449824931367, 31.337371488669277],
            [30.04443323836475, 31.337489505859907],
            [30.04613627661167, 31.3542008821653],
            [30.045993839362144, 31.354298607897146],
            [30.044921169436098, 31.355572657127205],
            [30.04479114805065, 31.355838195806125],
            [30.044763286303017, 31.356042043680848],
            [30.038595809870063, 31.355242801936544],
            [30.037899220236365, 31.355253530775894],
            [30.036314420491763, 31.35503618679372],
            [30.03597076232215, 31.35495572052738],
            [30.03479798842454, 31.354862022566657],
            [30.032805652761816, 31.354604530511082],
            [30.032536289625448, 31.354475784484944],
            [30.025317571683203, 31.353650492461554],
            [30.024620888734546, 31.3537148654968],
            [30.024453684102898, 31.35378460292763],
            [30.024216810392044, 31.353940171042556],
            [30.023877754879923, 31.354337137956495],
            [30.02360836748206, 31.354980868087218],
            [30.023645524398994, 31.355930370161452],
            [30.024179653677624, 31.358033222008867],
            [30.0242168103895, 31.358440917758323],
            [30.024588376732822, 31.359969776853546],
            [30.024644111571675, 31.360919278870835],
            [30.02459766587983, 31.361713212698717],
            [30.017168554583563, 31.390857019792232],
            [30.01682947496991, 31.391017952324916],
            [30.016634387543526, 31.391060867666965],
            [30.013675514449673, 31.39022938288165],
            [30.013090232407123, 31.390122094526532],
            [30.012950879030814, 31.3902240184639],
            [30.012235528591493, 31.39000944172792],
            [30.011696689808222, 31.38961783923173],
            [30.011654883228527, 31.38943008461027],
            [30.01144585006581, 31.389151134886966],
            [30.011204300084717, 31.389049210949594],
            [30.010893071357255, 31.38916722814023],
            [30.01082803836551, 31.389333525090663],
            [30.010479646579466, 31.38945154227144],
            [30.010210222784583, 31.38944081343593],
            [30.009950088771035, 31.389392533676123],
            [30.008510048827954, 31.388952651377153],
            [30.008352107687337, 31.38875416789882],
            [30.007539171377147, 31.388496675797516],
            [30.006178068857373, 31.388051429123774],
            [30.005969024154105, 31.387793937071486],
            [30.005843597120712, 31.387445249917345],
            [30.00599113897975, 31.368310106911967],
            [30.006102629543594, 31.366647137301925],
            [30.006446391248232, 31.365236295432098],
            [30.00659969001223, 31.36460865848894],
            [30.00710603876058, 31.36350895284896],
            [30.00782607154889, 31.362511171041486],
            [30.014589479127476, 31.35456110348905],
            [30.01536984263346, 31.353187812506],
            [30.01556493255551, 31.35284448970665],
            [30.0161734248218, 31.351063503011666],
            [30.01655431123089, 31.349475635170258],
            [30.016647210128244, 31.348225725833114],
            [30.016572891017788, 31.347485436104208],
            [30.01612233021557, 31.346133602829696],
            [30.016131620149675, 31.345935119372722],
            [30.014863536071328, 31.342534078315833],
            [30.014668444777747, 31.341884983767358],
            [30.014371162048572, 31.341681135850465],
            [30.013911301102663, 31.341600669584125],
            [30.01383233486717, 31.34152556773554],
            [30.01276860706875, 31.34205128070438],
            [30.012601382451443, 31.342067373957647],
            [30.012350544996846, 31.342072738375403],
            [30.01199751343058, 31.34205128070438],
            [30.011189252187492, 31.34172405115226],
            [30.010506405674818, 31.341380728391783],
            [30.010120850812175, 31.340999854731106],
            [30.009967557498626, 31.34085501545169],
            [30.009995429027818, 31.34074236267882],
            [30.00976781131043, 31.339937700015422],
            [30.009688841776217, 31.339170588276314],
            [30.009642389075346, 31.338778985631183],
            [30.011974287602026, 31.329621924153997],
            [30.01216009388968, 31.329557551140923],
            [30.012215835708094, 31.329219592822298],
            [30.01203003058335, 31.32897819463445],
            [30.01189996851772, 31.328924551475517],
            [30.011704875099554, 31.3290962095841],
            [30.01163983540188, 31.329235686068444],
            [30.010181239035926, 31.328731430799383],
            [30.009614517445655, 31.328473938640865],
            [30.008917724191548, 31.3282379042596],
            [30.000072669664966, 31.330694807640025],
            [29.998493112653403, 31.331714047114968],
            [29.998084282050137, 31.331735504785993],
            [29.997907741041722, 31.33160675875985],
            [29.99768474141968, 31.33167113177949],
            [29.997675449755377, 31.33192862383178],
            [29.997201573860426, 31.332384599341044],
            [29.996922822277103, 31.332980049711956],
            [29.996848488389332, 31.333366287790394],
            [29.99758253309157, 31.33368278843799],
            [29.997800887113538, 31.333881271894967],
            [29.99802853228456, 31.333859814223942],
            [29.998102865288523, 31.33368278843799],
            [29.998000657393707, 31.33340383871468],
            [29.997289845031936, 31.333039058307275],
            [29.997257324083165, 31.333253635017513],
        ];

        const routeLine = L.polyline(route, {
            color: 'blue',
            weight: 4
        }).addTo(map);

        map.fitBounds(routeLine.getBounds());

        // ===============================
        // ICONS
        // ===============================
        const startIcon = L.icon({
            iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
        });

        const endIcon = L.icon({
            iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
        });

        const busIcon = L.icon({
            iconUrl: '/icons/Bus.png',
            iconSize: [75, 75],
            iconAnchor: [38, 75],
            popupAnchor: [0, -75]
        });

        L.marker(route[0], { icon: startIcon }).addTo(map).bindPopup("Start");
        L.marker(route[route.length - 1], { icon: endIcon }).addTo(map).bindPopup("End");

        // ===============================
        // SPEED CONTROL
        // ===============================
        let animationSpeed = 1000;
        const slider = document.getElementById("speedSlider");
        const speedValue = document.getElementById("speedValue");

        slider.addEventListener("input", () => {
            animationSpeed = parseInt(slider.value);
            speedValue.innerText = animationSpeed + " ms";
        });

        // ===============================
        // DISTANCE CALCULATION (Haversine)
        // ===============================
        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const toRad = deg => deg * Math.PI / 180;

            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);

            const a =
                Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) *
                Math.cos(toRad(lat2)) *
                Math.sin(dLng / 2) ** 2;

            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        function calculateRemainingDistance(index) {
            let distance = 0;

            for (let i = index; i < route.length - 1; i++) {
                distance += getDistance(
                    route[i][0], route[i][1],
                    route[i + 1][0], route[i + 1][1]
                );
            }

            return distance;
        }

        // ===============================
        // SMOOTH ANIMATION
        // ===============================
        function animateMarker(marker, from, to, duration) {
            const startTime = performance.now();

            function animate(time) {
                const progress = Math.min((time - startTime) / duration, 1);

                const lat = from[0] + (to[0] - from[0]) * progress;
                const lng = from[1] + (to[1] - from[1]) * progress;

                marker.setLatLng([lat, lng]);

                if (progress < 1) requestAnimationFrame(animate);
            }

            requestAnimationFrame(animate);
        }

        // ===============================
        // SIGNALR TRACKING
        // ===============================
        const markers = {};
        const lastPositions = {};
        let routeIndex = 0;

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/trackingHub")
            .withAutomaticReconnect()
            .build();

        connection.on("ReceiveLocationUpdate", (id, lat, lng, speed) => {

            const newPos = [lat, lng];

            if (!markers[id]) {
                markers[id] = L.marker(newPos, { icon: busIcon }).addTo(map);
                lastPositions[id] = newPos;
                routeIndex = 0;
                return;
            }

            animateMarker(markers[id], lastPositions[id], newPos, animationSpeed);
            lastPositions[id] = newPos;

            // ===============================
            // DISTANCE CALCULATION
            // ===============================

            const remainingDistanceMeters = calculateRemainingDistance(routeIndex);
            const remainingDistanceKm = remainingDistanceMeters / 1000;

            document.getElementById("distance").innerText =
                remainingDistanceKm >= 1
                    ? remainingDistanceKm.toFixed(2) + " km"
                    : Math.round(remainingDistanceMeters) + " m";

            // ===============================
            // ETA CALCULATION (REALISTIC)
            // ===============================

            let speedKmPerHour = speed > 0 ? speed : 30; // default 30 km/h

            const etaHoursDecimal = remainingDistanceKm / speedKmPerHour;

            let totalMinutes = Math.ceil(etaHoursDecimal * 60);

            if (totalMinutes < 1)
                totalMinutes = 1;

            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            let etaFormatted;

            if (hours > 0)
                etaFormatted = `${hours} hr ${minutes} min`;
            else
                etaFormatted = `${minutes} min`;

            document.getElementById("eta").innerText = etaFormatted;

            routeIndex++;
        });

        connection.start()
            .then(() => console.log("SignalR connected"))
            .catch(err => console.error(err));

    </script>

</body>
</html>